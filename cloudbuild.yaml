steps:
#Build the Image
#We are using a ubuntu image tagged as ubuntu:latest
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-east1-docker.pkg.dev/jlopez-370123/gcp-prismacloud-demo/gcp-pc-image:latest', '.']

#Call the twistcli.sh script passing the image built in the previous step as a PARAMETER
#all the variables are passed to the Container in the ENV: section
#- name: 'us-east1-docker.pkg.dev/jlopez-370123/twistcli/twistcli:latest'
- name: 'ubuntu'
  entrypoint: /bin/sh
  args: [
  '-c',
  'curl -k -u $$PCC_USER:$$PCC_PASS --output ./twistcli $$PCC_CONSOLE_URL/api/v1/util/twistcli',
  'chmod a+x ./twistcli',
  ./twistcli images scan --address $$PCC_CONSOLE_URL --user $$PCC_USER --password $$PCC_PASS --details us-east1-docker.pkg.dev/jlopez-370123/gcp-prismacloud-demo/gcp-pc-image:latest
  #args: ['/twistcli.sh', 'us-east1-docker.pkg.dev/jlopez-370123/gcp-prismacloud-demo/gcp-pc-image:latest']
  
  secretEnv: [
      PCC_CONSOLE_URL,
      PCC_USER,
      PCC_PASS
  ]
  
#If the PRISMA SCAN verdict is continue the Image is pushed to the Google Container Registry
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-east1-docker.pkg.dev/jlopez-370123/gcp-prismacloud-demo/gcp-pc-image:latest']

#In case the image is pushed to the registry it is displayed in the Pipeline log.
images:
- 'us-east1-docker.pkg.dev/jlopez-370123/gcp-prismacloud-demo/gcp-pc-image:latest'

availableSecrets:
  - versionName: projects/183615182034/secrets/_PCC_CONSOLE_URL/versions/1
    env: 'PCC_CONSOLE_URL'
  - versionName: projects/183615182034/secrets/_PCC_USER/versions/1
    env: 'PCC_USER'
  - versionName: projects/183615182034/secrets/_PCC_PASS/versions/1
    env: 'PCC_PASS'
